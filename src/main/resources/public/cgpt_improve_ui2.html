<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Selenium Recorder Control Panel</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        :root {
            --bg: #020617;
            --bg-alt: #020617;
            --card: #020617;
            --card-elevated: #020617;
            --border-subtle: #1f2937;
            --accent: #2563eb;
            --accent-soft: #1d4ed8;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --radius-lg: 16px;
            --radius-md: 10px;
            --shadow-soft: 0 20px 50px rgba(15, 23, 42, 0.85);
            --transition-fast: 0.18s ease-out;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            color: var(--text-main);
            background: radial-gradient(circle at 0% -20%, rgba(59, 130, 246, 0.45), transparent 60%),
            radial-gradient(circle at 100% -10%, rgba(236, 72, 153, 0.35), transparent 55%),
            radial-gradient(circle at 50% 110%, rgba(34, 197, 94, 0.35), transparent 60%),
            #020617;
            padding: 16px;
        }

        .app-shell {
            max-width: 1200px;
            margin: 0 auto;
        }

        header.app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 24px;
        }

        .app-title-block h1 {
            margin: 0;
            font-size: 1.9rem;
            letter-spacing: 0.03em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-orb {
            width: 40px;
            height: 40px;
            border-radius: 999px;
            background: conic-gradient(from 210deg,
            #38bdf8,
            #6366f1,
            #ec4899,
            #22c55e,
            #38bdf8);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.9),
            0 12px 30px rgba(15, 23, 42, 0.9);
        }

        .logo-orb-inner {
            width: 26px;
            height: 26px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 0, #e5e7eb, #020617);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
        }

        .app-title-block p {
            margin: 4px 0 0;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .badge {
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            font-size: 0.75rem;
            color: var(--text-muted);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(8px);
        }

        .badge-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
        }

        .shell-grid {
            display: grid;
            grid-template-columns: minmax(0, 1.5fr) minmax(0, 1fr);
            gap: 20px;
        }

        /* Card styling */
        .card {
            position: relative;
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.4), transparent 60%),
            rgba(15, 23, 42, 0.9);
            border-radius: var(--radius-lg);
            padding: 16px 16px 14px;
            border: 1px solid rgba(31, 41, 55, 0.9);
            box-shadow: var(--shadow-soft);
            overflow: hidden;
        }

        .card::before {
            content: "";
            position: absolute;
            inset: -40%;
            background: radial-gradient(circle at 0% 0%, rgba(59, 130, 246, 0.2), transparent 55%),
            radial-gradient(circle at 100% 0%, rgba(244, 63, 94, 0.18), transparent 55%),
            radial-gradient(circle at 50% 130%, rgba(34, 197, 94, 0.3), transparent 60%);
            mix-blend-mode: soft-light;
            opacity: 0.9;
            pointer-events: none;
        }

        .card > * {
            position: relative;
            z-index: 1;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .card-title-block {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.09em;
        }

        .card-subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .tag-pill {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            border-radius: 999px;
            padding: 3px 9px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            color: #e5e7eb;
            background: rgba(15, 23, 42, 0.7);
        }

        /* URL launcher */
        .url-form {
            display: flex;
            gap: 10px;
            margin-bottom: 14px;
        }

        #url-input {
            flex-grow: 1;
            padding: 11px 12px;
            border-radius: var(--radius-md);
            border: 1px solid #374151;
            background: rgba(15, 23, 42, 0.9);
            color: var(--text-main);
            font-size: 0.92rem;
            outline: none;
            transition: border-color var(--transition-fast),
            box-shadow var(--transition-fast),
            background var(--transition-fast),
            transform var(--transition-fast);
        }

        #url-input::placeholder {
            color: #6b7280;
        }

        #url-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.7);
            transform: translateY(-0.5px);
        }

        #launch-btn {
            white-space: nowrap;
            padding: 10px 18px;
            border-radius: var(--radius-md);
            border: none;
            background: linear-gradient(to right, var(--accent), var(--accent-soft));
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 14px 32px rgba(37, 99, 235, 0.6);
            transform-origin: center;
            transition: background var(--transition-fast),
            transform var(--transition-fast),
            box-shadow var(--transition-fast);
        }

        #launch-btn span.icon {
            font-size: 1.05rem;
        }

        #launch-btn:hover {
            background: linear-gradient(to right, #1d4ed8, #1e3a8a);
            transform: translateY(-1px);
            box-shadow: 0 20px 50px rgba(37, 99, 235, 0.75);
        }

        #launch-btn:active {
            transform: translateY(0);
            box-shadow: 0 10px 20px rgba(15, 23, 42, 0.95);
        }

        /* Status + stats */
        .status-row {
            display: grid;
            grid-template-columns: minmax(0, 1.3fr) minmax(0, 0.9fr);
            gap: 10px;
            margin-top: 6px;
            margin-bottom: 8px;
        }

        .status-box {
            padding: 12px 12px 10px;
            border-radius: var(--radius-md);
            font-size: 0.86rem;
            line-height: 1.6;
            border: 1px solid transparent;
            background: rgba(15, 23, 42, 0.85);
        }

        .status-box p {
            margin: 3px 0;
        }

        .status-label {
            font-weight: 600;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            font-size: 0.7rem;
            opacity: 0.85;
            margin-bottom: 4px;
        }

        .status-box.info {
            border-color: rgba(59, 130, 246, 0.7);
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
        }

        .status-box.success {
            border-color: rgba(22, 163, 74, 0.9);
            box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.4);
        }

        .status-box.error {
            border-color: rgba(248, 113, 113, 0.9);
            box-shadow: 0 0 0 1px rgba(248, 113, 113, 0.35);
        }

        .stat-chip {
            background: rgba(15, 23, 42, 0.9);
            border-radius: 999px;
            padding: 6px 9px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border: 1px solid rgba(55, 65, 81, 0.9);
            font-size: 0.8rem;
            margin-bottom: 4px;
        }

        .stat-chip span.label {
            color: var(--text-muted);
        }

        .stat-chip span.value {
            font-weight: 600;
            color: #e5e7eb;
        }

        code {
            background: rgba(15, 23, 42, 0.95);
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        /* Save & Quit button */
        #saveQuitBtn {
            width: 100%;
            margin-top: 10px;
            padding: 11px 16px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(127, 29, 29, 0.9);
            background: linear-gradient(to right, #b91c1c, #7f1d1d);
            color: #fee2e2;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 14px 35px rgba(127, 29, 29, 0.9);
            transition: opacity var(--transition-fast),
            transform var(--transition-fast),
            box-shadow var(--transition-fast),
            background var(--transition-fast);
        }

        #saveQuitBtn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 20px 50px rgba(127, 29, 29, 1);
            background: linear-gradient(to right, #991b1b, #7f1d1d);
        }

        #saveQuitBtn:disabled {
            opacity: 0.55;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Side card */
        .side-card {
            position: relative;
            background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.22), transparent 55%),
            rgba(15, 23, 42, 0.96);
            border-radius: var(--radius-lg);
            padding: 14px 14px 12px;
            border: 1px solid rgba(31, 41, 55, 0.9);
            box-shadow: var(--shadow-soft);
            overflow: hidden;
        }

        .side-card > * {
            position: relative;
            z-index: 1;
        }

        .side-card::before {
            content: "";
            position: absolute;
            inset: -40%;
            background: radial-gradient(circle at 0% 0%, rgba(37, 99, 235, 0.25), transparent 60%),
            radial-gradient(circle at 110% 0%, rgba(249, 115, 22, 0.22), transparent 60%);
            opacity: 0.8;
            mix-blend-mode: soft-light;
            pointer-events: none;
        }

        .side-card h2 {
            margin: 0 0 6px;
            font-size: 1rem;
        }

        .side-card p {
            margin: 4px 0;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .mini-list {
            margin-top: 8px;
            padding-left: 18px;
            font-size: 0.82rem;
            color: var(--text-muted);
        }

        .mini-list li {
            margin-bottom: 5px;
        }

        .pill-tip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            border: 1px solid rgba(55, 65, 81, 0.9);
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .pill-tip span.icon {
            font-size: 0.85rem;
        }

        @media (max-width: 900px) {
            .shell-grid {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        @media (max-width: 640px) {
            body {
                padding: 16px;
            }

            header.app-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .card {
                padding: 18px 16px;
            }

            .side-card {
                padding: 16px 14px;
            }
        }

        .button-row {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .replay-status-text {
            margin-top: 6px;
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: center;
            min-height: 1.2em; /* keeps layout stable even when empty */
        }

        .report-btn {
            width: 100%;
            margin-top: 8px;
            padding: 9px 14px;
            border-radius: var(--radius-md);
            border: 1px solid #0f766e;
            background: linear-gradient(to right, #0f766e, #14b8a6);
            color: #ecfeff;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 10px 26px rgba(15, 118, 110, 0.85);
            transition: opacity var(--transition-fast),
            transform var(--transition-fast),
            box-shadow var(--transition-fast),
            background var(--transition-fast);
        }

        .report-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 18px 40px rgba(15, 118, 110, 0.95);
            background: linear-gradient(to right, #115e59, #0f766e);
        }

        .report-btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.35);
        }

        .report-btn:focus-visible {
            outline: 2px solid #a5f3fc;
            outline-offset: 2px;
        }

        .report-btn:disabled {
            opacity: 0.6;
            cursor: default;
            box-shadow: none;
        }

        .replay-btn {
            width: 100%;
            margin-top: 10px;
            padding: 11px 16px;
            border-radius: var(--radius-md);
            border: 1px solid #1d4ed8;
            background: linear-gradient(to right, #1d4ed8, #3b82f6);
            color: #eff6ff;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 14px 35px rgba(37, 99, 235, 0.65);
            transition: opacity var(--transition-fast),
            transform var(--transition-fast),
            box-shadow var(--transition-fast),
            background var(--transition-fast);
        }

        .replay-btn .replay-icon {
            font-size: 1rem;
            line-height: 1;
        }

        .replay-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 20px 50px rgba(37, 99, 235, 0.85);
            background: linear-gradient(to right, #1e40af, #2563eb);
        }

        .replay-btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.35);
        }

        .replay-btn:focus-visible {
            outline: 2px solid #bfdbfe;
            outline-offset: 2px;
        }

        /* Disabled / loading state */
        .replay-btn:disabled,
        .replay-btn.is-loading {
            opacity: 0.65;
            cursor: default;
            box-shadow: none;
        }

        /* Optional tiny spinner when loading */
        .replay-btn.is-loading .replay-icon {
            animation: spin 0.75s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Beautiful dark neon select */
        .select-container {
            position: relative;
            width: 190px;
        }

        .pretty-select {
            width: 100%;
            padding: 10px 14px;
            background: rgba(15, 23, 42, 0.85); /* dark matte glass */
            color: #e5e7eb;
            border: 1px solid rgba(55, 65, 81, 0.9);
            border-radius: 10px;
            font-size: 0.9rem;
            appearance: none;
            outline: none;
            cursor: pointer;

            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);

            transition: all 0.22s ease-out;
        }

        .pretty-select:hover {
            border-color: #3b82f6;
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.45);
            background: rgba(30, 41, 59, 0.88);
        }

        .pretty-select:focus {
            border-color: #2563eb;
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.65);
        }

        .select-container::after {
            content: "‚ñæ";
            position: absolute;
            font-size: 0.9rem;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            pointer-events: none;
        }

        /* Gherkin card tweaks when in side panel */
        #test-generator-card {
            margin-bottom: 10px;
            padding: 10px 10px 8px;
            border-radius: var(--radius-md);
            background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.12), transparent 55%),
            rgba(15, 23, 42, 0.96);
            border: 1px solid rgba(55, 65, 81, 0.9);
        }

        #test-generator-card h3 {
            margin: 0 0 4px;
            font-size: 0.96rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        #test-generator-card p.description {
            margin: 0 0 8px;
            font-size: 0.82rem;
            color: var(--text-muted);
        }

        .field-group {
            margin-bottom: 8px;
        }

        .field-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .field-hint {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .field-input {
            width: 100%;
            padding: 9px 10px;
            border-radius: 7px;
            border: 1px solid #374151;
            background: rgba(15, 23, 42, 0.95);
            color: var(--text-main);
            font-size: 0.9rem;
            outline: none;
            transition: border-color var(--transition-fast),
            box-shadow var(--transition-fast),
            transform var(--transition-fast);
        }

        .field-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.7);
            transform: translateY(-0.5px);
        }

        .btn-green {
            width: 100%;
            padding: 9px 12px;
            border-radius: var(--radius-md);
            border: none;
            background: linear-gradient(to right, #16a34a, #22c55e);
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 14px 35px rgba(22, 163, 74, 0.9);
            transition: background var(--transition-fast),
            transform var(--transition-fast),
            box-shadow var(--transition-fast);
        }

        .btn-green:hover {
            background: linear-gradient(to right, #15803d, #16a34a);
            transform: translateY(-1px);
            box-shadow: 0 22px 55px rgba(22, 163, 74, 1);
        }

        #generatorStatus {
            margin-top: 6px;
            font-weight: 600;
            font-size: 0.84rem;
            min-height: 1.2em;
            text-align: center;
        }

    </style>
</head>
<body>

<div class="app-shell">
    <header class="app-header">
        <div class="app-title-block">
            <h1>
                <span class="logo-orb">
                    <span class="logo-orb-inner">‚è∫</span>
                </span>
                Selenium Web Action Recorder
            </h1>
            <p>Launch a browser session, record user actions, replay them, and generate Gherkin features.</p>
        </div>
        <div class="badge">
            <span class="badge-dot"></span>
            Live Recorder Panel
        </div>
    </header>

    <div class="shell-grid">
        <!-- Main control card -->
        <div class="card">
            <div class="card-header">
                <div class="card-title-block">
                    <div class="card-title">Browser Session</div>
                    <div class="card-subtitle">Start recording by launching a URL under test.</div>
                </div>
                <span class="tag-pill">Selenium ¬∑ Cucumber</span>
            </div>

            <form class="url-form" onsubmit="launchBrowser(event)">
                <input
                        type="text"
                        name="url"
                        id="url-input"
                        placeholder="Enter URL (e.g., https://example.com)"
                        required
                >
                <button type="submit" id="launch-btn">
                    <span class="icon">üöÄ</span>
                    <span>Launch</span>
                </button>
            </form>

            <div id="control-panel">
                <div class="status-row">
                    <div id="status-message" class="status-box info">
                        <div class="status-label">Recorder Status</div>
                        <p>Waiting for browser session...</p>
                    </div>

                    <div class="status-box" style="border:1px solid rgba(55,65,81,0.9);">
                        <div class="status-label">Quick Stats</div>
                        <div class="stat-chip">
                            <span class="label">Events:</span>
                            <span class="value" id="stat-events">0</span>
                        </div>
                        <div class="stat-chip">
                            <span class="label">Script:</span>
                            <span class="value" id="stat-script">Unknown</span>
                        </div>
                    </div>
                </div>

                <!-- üîπ Recording name / timestamp / recent block -->
                <div class="field-group" style="margin-top: 10px;">
                    <label for="recordingName" class="field-label">Recording Name</label>
                    <div class="field-hint">
                        This will be used as the base name for the saved JSON file
                        (and can also be reused when generating feature files).
                    </div>
                    <div style="display:flex; gap:8px; margin-bottom:4px; flex-wrap:wrap;">
                        <input
                                type="text"
                                id="recordingName"
                                class="field-input"
                                placeholder="e.g., user_login_flow"
                                style="flex:1 1 0;"
                        >
                        <div class="select-container">
                            <select id="recordingRecentNames" class="pretty-select">
                                <option value="">Recent‚Ä¶</option>
                                <!-- items are appended dynamically -->
                            </select>
                        </div>
                    </div>

                    <label style="display:flex; align-items:center; gap:6px; font-size:0.8rem; color:#9ca3af; margin-bottom:4px;">
                        <input
                                type="checkbox"
                                id="addTimestamp"
                                checked
                                style="accent-color:#22c55e; width:14px; height:14px;"
                        >
                        <span>Append timestamp to filename (recommended)</span>
                    </label>

                    <div class="field-hint">
                        Final filename:
                        <code id="recordingFilenamePreview">recording_YYYYMMDD_HHMMSS.json</code>
                    </div>
                </div>

                <button id="saveQuitBtn" onclick="saveAndQuit()" disabled>
                    üíæ Save All Actions & Quit Browser
                </button>

                <button id="replayBtn" type="button" class="replay-btn">
                    <span class="replay-icon">‚èØ</span>
                    <span class="replay-label">Replay Recorded Script</span>
                </button>

                <p id="replayStatus" class="replay-status-text"></p>

                <button id="openReportBtn"
                        type="button"
                        class="report-btn"
                        style="display: none;"
                        onclick="window.open('http://localhost:4567/view-replay-report', '_blank')">
                    <span>üìÑ Open Last Replay Report</span>
                </button>
            </div>
        </div>

        <!-- Right side: Gherkin generator + help -->
        <aside class="side-card">
            <!-- üîπ Gherkin generator moved here so it‚Äôs always visible -->
            <div id="test-generator-card">
                <h3>Generate Gherkin Feature</h3>
                <p class="description">
                    After saving a recording, generate a Cucumber <code>.feature</code>
                    file using the selected recording name.
                </p>

                <div class="field-group">
                    <label for="featureInput" class="field-label">Feature Name</label>
                    <div class="field-hint">Example: <code>User Login Flow</code></div>
                    <input
                            type="text"
                            id="featureInput"
                            class="field-input"
                            placeholder="e.g., User Login Flow"
                            required
                    >
                </div>

                <div class="field-group">
                    <label for="scenarioInput" class="field-label">Scenario Name</label>
                    <div class="field-hint">Example: <code>Successful Login</code></div>
                    <input
                            type="text"
                            id="scenarioInput"
                            class="field-input"
                            placeholder="e.g., Successful Login"
                            required
                    >
                </div>

                <button type="button" class="btn-green" onclick="generateTest()">
                    üíæ Generate Gherkin Feature
                </button>

                <p id="generatorStatus"></p>
            </div>

            <h2 style="margin-top:10px;">How this panel works</h2>
            <p>
                This panel orchestrates your Selenium session, the recorder script,
                raw JSON recordings, the replay engine and the Gherkin generator.
            </p>
            <ul class="mini-list">
                <li><strong>Launch Browser:</strong> Opens a Selenium-driven browser at your target URL.</li>
                <li><strong>Recorder Script:</strong> Injected into the page; records navigations, clicks, inputs, and hovers.</li>
                <li><strong>Save & Quit:</strong> Persists all recorded actions into <code>/recordings/*.json</code> and closes the browser.</li>
                <li><strong>Replay Script:</strong> Uses the JSON to drive a headless browser and produces an HTML execution report.</li>
                <li><strong>Generate Gherkin:</strong> Turns a chosen recording into a readable Cucumber <code>.feature</code> file.</li>
            </ul>
            <p class="pill-tip">
                <span class="icon">üí°</span>
                Tip: Keep this panel on one screen and your AUT on another for a smooth
                record ‚Üí replay ‚Üí report ‚Üí generate loop.
            </p>
        </aside>
    </div>
</div>

<script>
    const BASE_URL      = 'http://localhost:4567';

    const saveQuitBtn   = document.getElementById('saveQuitBtn');
    const statusBox     = document.getElementById('status-message');
    const statEvents    = document.getElementById('stat-events');
    const statScript    = document.getElementById('stat-script');
    const replayStatus  = document.getElementById('replayStatus');
    const replayBtn     = document.getElementById('replayBtn');
    const openReportBtn = document.getElementById('openReportBtn');
    let statusInterval;

    // ---- LocalStorage keys ----
    const LS_KEY_LAST_NAME    = '__recorder_lastRecordingName';
    const LS_KEY_RECENT_NAMES = '__recorder_recentRecordingNames';
    const MAX_RECENT_NAMES    = 10;

    // ---------- Helpers ----------

    function humanizeRecordingName(recName) {
        if (!recName) return '';
        const withSpaces = recName.replace(/[_\-]+/g, ' ').trim();
        return withSpaces
            .split(/\s+/)
            .map(w => w.charAt(0).toUpperCase() + w.slice(1))
            .join(' ');
    }

    function autoFillFeatureScenarioFromRecording(recName) {
        const featureInput  = document.getElementById('featureInput');
        const scenarioInput = document.getElementById('scenarioInput');
        const pretty        = humanizeRecordingName(recName);

        if (featureInput) {
            featureInput.value = pretty || recName || '';
        }
        if (scenarioInput) {
            scenarioInput.value = `Happy path - ${pretty || recName || ''}`;
        }
    }

    function sanitizeName(raw) {
        if (!raw) return '';
        return raw.replace(/[^a-zA-Z0-9_\-]/g, '_');
    }

    function makeTimestampForFile() {
        const now = new Date();
        const yyyy = now.getFullYear().toString();
        const mm   = String(now.getMonth() + 1).padStart(2, '0');
        const dd   = String(now.getDate()).padStart(2, '0');
        const hh   = String(now.getHours()).padStart(2, '0');
        const mi   = String(now.getMinutes()).padStart(2, '0');
        const ss   = String(now.getSeconds()).padStart(2, '0');
        return `${yyyy}${mm}${dd}_${hh}${mi}${ss}`;
    }

    function buildFilename(baseName, withTimestamp) {
        const clean = sanitizeName(baseName || 'recording');
        if (withTimestamp) {
            return `${clean}_${makeTimestampForFile()}.json`;
        }
        return `${clean}.json`;
    }

    function loadRecentNames() {
        try {
            const raw = localStorage.getItem(LS_KEY_RECENT_NAMES);
            if (!raw) return [];
            const parsed = JSON.parse(raw);
            return Array.isArray(parsed) ? parsed : [];
        } catch (e) {
            console.warn('[panel] Failed to load recent names', e);
            return [];
        }
    }

    function saveRecentName(name) {
        const clean = sanitizeName(name);
        if (!clean) return;

        let arr = loadRecentNames();
        arr = arr.filter(n => n !== clean);
        arr.unshift(clean);
        if (arr.length > MAX_RECENT_NAMES) {
            arr = arr.slice(0, MAX_RECENT_NAMES);
        }

        try {
            localStorage.setItem(LS_KEY_RECENT_NAMES, JSON.stringify(arr));
            localStorage.setItem(LS_KEY_LAST_NAME, clean);
        } catch (e) {
            console.warn('[panel] Failed to save recent name', e);
        }
    }

    // Load recordings from server and fill <select id="recordingRecentNames">
    async function refreshRecordingDropdownFromServer(selectedName) {
        const select = document.getElementById('recordingRecentNames');
        if (!select) return;

        try {
            const resp = await fetch(`${BASE_URL}/recordings-list`);
            if (!resp.ok) throw new Error('HTTP ' + resp.status);

            const list = await resp.json(); // [{name,fileName}, ...]

            // Keep only "Recent‚Ä¶" option
            while (select.options.length > 1) {
                select.remove(1);
            }

            list.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.name;          // logical name
                opt.textContent = item.name;
                if (item.fileName) {
                    opt.dataset.filename = item.fileName; // REAL JSON filename
                }
                select.appendChild(opt);
            });

            if (selectedName) {
                select.value = selectedName;
            }
        } catch (e) {
            console.error('Failed to load recordings list', e);
        }
    }

    // ---------- Recording name + preview UI ----------

    function initRecordingNameUi() {
        const nameInput    = document.getElementById('recordingName');
        const tsCheckbox   = document.getElementById('addTimestamp');
        const preview      = document.getElementById('recordingFilenamePreview');
        const recentSelect = document.getElementById('recordingRecentNames');

        if (!nameInput) return;

        // For a NEW recording: preview ‚Äúif you save now, this will be the filename‚Äù
        function updatePreviewForNewRecording() {
            if (!preview) return;
            const withTs = tsCheckbox ? tsCheckbox.checked : true;
            const fn = buildFilename(nameInput.value.trim(), withTs);
            preview.textContent = fn;
        }

        function onNameChanged() {
            updatePreviewForNewRecording();
            const val = nameInput.value.trim();
            if (val) {
                autoFillFeatureScenarioFromRecording(val);
            }
        }

        // When selecting an EXISTING recording:
        // - set recordingName
        // - auto-fill Feature & Scenario
        // - preview shows REAL filename from server (no new timestamp)
        if (recentSelect) {
            recentSelect.addEventListener('change', () => {
                const val = recentSelect.value;

                if (!val) {
                    // user picked the "Recent‚Ä¶" placeholder ‚Üí treat as "new"
                    updatePreviewForNewRecording();
                    return;
                }

                nameInput.value = val;
                autoFillFeatureScenarioFromRecording(val);

                const selectedOpt      = recentSelect.options[recentSelect.selectedIndex];
                const existingFileName = selectedOpt && selectedOpt.dataset.filename;

                if (preview) {
                    preview.textContent = existingFileName ||
                        buildFilename(nameInput.value.trim(), tsCheckbox ? tsCheckbox.checked : true);
                }
            });
        }

        nameInput.addEventListener('input', onNameChanged);

        if (tsCheckbox) {
            tsCheckbox.addEventListener('change', onNameChanged);
        }

        nameInput.addEventListener('keydown', (ev) => {
            if (ev.key === 'Enter') {
                ev.preventDefault();
                if (saveQuitBtn && !saveQuitBtn.disabled) {
                    saveQuitBtn.click();
                }
            }
        });

        // Initial state: treat as ‚Äúnew recording‚Äù
        onNameChanged();
    }

    // ---------- Browser launch / status ----------

    function launchBrowser(event) {
        event.preventDefault();
        const urlInput = document.getElementById('url-input');
        const url = urlInput.value.trim();
        if (!url) return;

        statusBox.className = 'status-box info';
        statusBox.innerHTML = `
            <div class="status-label">Recorder Status</div>
            <p>Connecting to browser session...</p>
        `;
        statEvents.textContent = '0';
        statScript.textContent = 'Not Detected';
        saveQuitBtn.disabled = true;
        saveQuitBtn.textContent = 'Waiting for session...';

        const params = new URLSearchParams();
        params.append('url', url);

        fetch(`${BASE_URL}/open`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
            },
            body: params.toString()
        }).catch(err => {
            console.error('Error launching browser:', err);
        });
    }

    function updateStatus() {
        fetch(`${BASE_URL}/recorder-status`)
            .then(response => {
                if (response.status === 400) {
                    throw new Error("No active browser session detected.");
                }
                if (!response.ok) {
                    throw new Error("HTTP Error: " + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                const totalActions = data.count || 0;
                const lastStepText = data.last_raw_gherkin || '';

                statusBox.className = 'status-box info';
                statusBox.innerHTML = `
                    <div class="status-label">Recorder Status</div>
                    <p>‚úÖ Status: <strong>${data.installed ? 'ACTIVE' : 'INJECTION PENDING/FAILED'}</strong></p>
                    ${
                    lastStepText
                        ? `<p>üìù Last Step: <code>${lastStepText}</code></p>`
                        : `<p>üìù Last Step: <em>No events recorded yet.</em></p>`
                }
                `;

                statEvents.textContent = totalActions;
                statScript.textContent = data.installed ? 'Injected' : 'Not Detected';

                saveQuitBtn.disabled = false;
                saveQuitBtn.textContent = 'üíæ Save All Actions & Quit Browser';
            })
            .catch(error => {
                statusBox.className = 'status-box error';
                statusBox.innerHTML = `
                    <div class="status-label">Recorder Status</div>
                    <p>üõë ${error.message}</p>
                    <p>Launch a URL above to begin recording.</p>
                `;
                statEvents.textContent = '0';
                statScript.textContent = 'Not Detected';

                saveQuitBtn.disabled = true;
                saveQuitBtn.textContent = 'Session Closed.';
            });
    }

    // ---------- Save & Quit (create JSON) ----------

    function saveAndQuit() {
        if (saveQuitBtn.disabled) return;

        const nameInput  = document.getElementById('recordingName');
        const tsCheckbox = document.getElementById('addTimestamp');

        let customName = nameInput ? nameInput.value.trim() : '';
        if (!customName) {
            alert('Please enter a Recording Name before saving.');
            if (nameInput) nameInput.focus();
            return;
        }

        const withTs        = tsCheckbox ? tsCheckbox.checked : true;
        const finalFileName = buildFilename(customName, withTs);

        autoFillFeatureScenarioFromRecording(customName);
        saveRecentName(customName);

        saveQuitBtn.disabled = true;
        saveQuitBtn.textContent = 'Saving actions...';
        statusBox.className = 'status-box info';
        statusBox.innerHTML = `
            <div class="status-label">Recorder Status</div>
            <p>Starting save and shutdown process...</p>
            <p>Target file: <code>${finalFileName}</code></p>
        `;

        let savedFileLocation = "";

        const params = new URLSearchParams();
        params.append('fileName', finalFileName);

        fetch(`${BASE_URL}/save-recorded-actions?` + params.toString())
            .then(response => response.text())
            .then(message => {
                savedFileLocation = message;
                statusBox.innerHTML = `
                    <div class="status-label">Recorder Status</div>
                    <p>üíæ Actions saved. Closing browser session...</p>
                    <p>üìÅ Saved as: <code>${finalFileName}</code></p>
                `;

                // Refresh dropdown from server so this recording appears with real filename
                refreshRecordingDropdownFromServer(customName);

                return fetch(`${BASE_URL}/quit`);
            })
            .then(response => response.text())
            .then(message => {
                statusBox.className = 'status-box success';
                statusBox.innerHTML = `
                    <div class="status-label">Recorder Status</div>
                    <p>‚úÖ Browser closed successfully.</p>
                    <p>üìÅ Actions saved to:<br><strong>${savedFileLocation || finalFileName}</strong></p>
                `;
                saveQuitBtn.textContent = 'Session Closed.';
            })
            .catch(error => {
                statusBox.className = 'status-box error';
                statusBox.innerHTML = `
                    <div class="status-label">Recorder Status</div>
                    <p>üõë Fatal error during shutdown:</p>
                    <p><code>${error}</code></p>
                `;
                saveQuitBtn.textContent = 'Error (Check Server Log)';
            });
    }

    // ---------- Replay ----------

    if (replayBtn) {
        replayBtn.addEventListener('click', async () => {
            replayBtn.disabled = true;
            replayBtn.classList.add('is-loading');

            if (openReportBtn) {
                openReportBtn.style.display = "none";
            }

            if (replayStatus) {
                replayStatus.textContent = "Replaying recorded script...";
                replayStatus.style.color = "#eab308";
            }

            statusBox.className = 'status-box info';
            statusBox.innerHTML = `
                <div class="status-label">Script Replay</div>
                <p>‚è≥ Replaying recorded script...</p>
            `;

            try {
                const select = document.getElementById("recordingRecentNames");
                let replayUrl = `${BASE_URL}/replay`;

                if (select && select.value && select.value.trim() !== "") {
                    const recName = select.value.trim();
                    replayUrl = `${BASE_URL}/replay?recording=${encodeURIComponent(recName)}`;
                }

                const resp = await fetch(replayUrl, { method: "POST" });
                const text = await resp.text();

                if (resp.ok) {
                    statusBox.className = 'status-box success';
                    statusBox.innerHTML = `
                        <div class="status-label">Script Replay</div>
                        <p>‚úÖ Replay completed successfully.</p>
                        <p class="small">You can open the detailed HTML report using the button below.</p>
                    `;
                    if (replayStatus) {
                        replayStatus.textContent = "Replay completed successfully.";
                        replayStatus.style.color = "#22c55e";
                    }
                    if (openReportBtn) {
                        openReportBtn.style.display = "inline-block";
                    }
                } else {
                    statusBox.className = 'status-box error';
                    statusBox.innerHTML = `
                        <div class="status-label">Script Replay</div>
                        <p>üõë Replay Failed:</p>
                        <p><code>${text}</code></p>
                        <p class="small">The replay report (with failures) is still available.</p>
                    `;
                    if (replayStatus) {
                        replayStatus.textContent = "Replay failed. See details above.";
                        replayStatus.style.color = "#f97316";
                    }
                    if (openReportBtn) {
                        openReportBtn.style.display = "inline-block";
                    }
                }
            } catch (err) {
                statusBox.className = 'status-box error';
                statusBox.innerHTML = `
                    <div class="status-label">Script Replay</div>
                    <p>üõë Replay failed:</p>
                    <p><code>${err.message}</code></p>
                `;
                if (replayStatus) {
                    replayStatus.textContent = "Replay failed due to an error.";
                    replayStatus.style.color = "#ef4444";
                }
                if (openReportBtn) {
                    openReportBtn.style.display = "inline-block";
                }
            } finally {
                replayBtn.disabled = false;
                replayBtn.classList.remove('is-loading');
            }
        });
    }

    // ---------- Generate Gherkin ----------

    function generateTest() {
        const featureName  = document.getElementById('featureInput').value.trim();
        const scenarioName = document.getElementById('scenarioInput').value.trim();
        const statusDiv    = document.getElementById('generatorStatus');

        const recordingSelect = document.getElementById('recordingRecentNames');
        const recordingName   = recordingSelect ? recordingSelect.value.trim() : "";

        if (!featureName) {
            statusDiv.textContent = "Please enter a Feature Name.";
            statusDiv.style.color = '#f97316';
            return;
        }

        if (!scenarioName) {
            statusDiv.textContent = "Please enter a Scenario Name.";
            statusDiv.style.color = '#f97316';
            return;
        }

        const payload = JSON.stringify({
            feature:   featureName,
            scenario:  scenarioName,
            recording: recordingName
        });

        statusDiv.textContent = "Generating feature file...";
        statusDiv.style.color = '#eab308';

        fetch(`${BASE_URL}/generate-test`, {
            method: 'POST',
            headers: {
                'Content-Type': 'text/plain',
            },
            body: payload
        })
            .then(response => response.json())
            .then(data => {
                statusDiv.textContent = data.message || 'Done.';
                statusDiv.style.color = data.status === "Success" ? '#22c55e' : '#f97316';
            })
            .catch(error => {
                statusDiv.textContent = "Error communicating with Java server.";
                statusDiv.style.color = '#ef4444';
                console.error('Fetch error:', error);
            });
    }

    // ---------- Startup ----------

    window.onload = function () {
        // Poll recorder status
        statusInterval = setInterval(updateStatus, 500);
        updateStatus();

        initRecordingNameUi();
        refreshRecordingDropdownFromServer();

        if (saveQuitBtn) {
            saveQuitBtn.addEventListener('click', saveAndQuit);
        }

        window.generateTest = generateTest;
    };
</script>

</body>
</html>
