<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Selenium Recorder Control Panel</title>
    <style>
        :root {
            --bg: #0b1220;
            --card-bg: #0f172a;
            --card-soft: #111827;
            --accent: #2563eb;
            --accent-soft: #1d4ed8;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --border-subtle: #1f2937;
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.75);
            --radius-lg: 14px;
            --radius-md: 10px;
            --transition-fast: 0.18s ease-out;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top left, #1f2937 0, #020617 45%, #000 100%);
            margin: 0;
            padding: 24px;
            color: var(--text-main);
        }

        .app-shell {
            max-width: 1200px;
            margin: 0 auto;
        }

        header.app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 24px;
        }

        .app-title-block h1 {
            margin: 0;
            font-size: 1.8rem;
            letter-spacing: 0.03em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .app-title-block h1 span.icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 0, #38bdf8 0, #1d4ed8 45%, #020617 100%);
            box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.7);
            font-size: 18px;
        }

        .app-title-block p {
            margin: 4px 0 0;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .badge {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.75rem;
            border: 1px solid rgba(148, 163, 184, 0.35);
            color: var(--text-muted);
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .badge span.dot {
            width: 7px;
            height: 7px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
        }

        .shell-grid {
            display: grid;
            grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
            gap: 20px;
        }

        /* Shared card styles */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 22px 20px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-subtle);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background:
                radial-gradient(circle at top left, rgba(59, 130, 246, 0.14), transparent 60%),
                radial-gradient(circle at bottom right, rgba(56, 189, 248, 0.08), transparent 55%);
            opacity: 0.75;
            pointer-events: none;
            mix-blend-mode: soft-light;
        }

        .card > * {
            position: relative;
            z-index: 1;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 18px;
            gap: 10px;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 0.04em;
            text-transform: uppercase;
            color: #e5e7eb;
        }

        .card-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* URL launcher */
        .url-form {
            display: flex;
            gap: 10px;
            margin-bottom: 14px;
        }

        #url-input {
            flex-grow: 1;
            padding: 11px 12px;
            border-radius: var(--radius-md);
            border: 1px solid #374151;
            background: #020617;
            color: var(--text-main);
            font-size: 0.92rem;
            outline: none;
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
        }

        #url-input::placeholder {
            color: #6b7280;
        }

        #url-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.6);
            background: #020617;
        }

        #launch-btn {
            white-space: nowrap;
            padding: 10px 18px;
            border-radius: var(--radius-md);
            border: none;
            background: linear-gradient(to right, var(--accent), var(--accent-soft));
            color: white;
            font-size: 0.92rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 12px 25px rgba(37, 99, 235, 0.45);
            transform-origin: center;
            transition:
                background var(--transition-fast),
                transform var(--transition-fast),
                box-shadow var(--transition-fast);
        }

        #launch-btn span {
            font-size: 1.05rem;
        }

        #launch-btn:hover {
            background: linear-gradient(to right, #1d4ed8, #1e3a8a);
            transform: translateY(-1px);
            box-shadow: 0 18px 40px rgba(37, 99, 235, 0.6);
        }

        #launch-btn:active {
            transform: translateY(0);
            box-shadow: 0 8px 16px rgba(15, 23, 42, 0.9);
        }

        /* Status */
        .status-box {
            margin-top: 10px;
            padding: 14px 14px 12px;
            border-radius: var(--radius-md);
            font-size: 0.86rem;
            line-height: 1.55;
            border: 1px solid transparent;
        }

        .status-box p {
            margin: 4px 0;
        }

        .status-label {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-size: 0.72rem;
            opacity: 0.9;
        }

        .status-box.info {
            background: rgba(37, 99, 235, 0.08);
            border-color: rgba(59, 130, 246, 0.6);
            color: #bfdbfe;
        }

        .status-box.success {
            background: rgba(16, 185, 129, 0.08);
            border-color: rgba(52, 211, 153, 0.6);
            color: #bbf7d0;
        }

        .status-box.error {
            background: rgba(220, 38, 38, 0.08);
            border-color: rgba(248, 113, 113, 0.8);
            color: #fecaca;
        }

        code {
            background: rgba(15, 23, 42, 0.9);
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        /* Buttons */
        #saveQuitBtn {
            width: 100%;
            margin-top: 12px;
            padding: 11px 16px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(127, 29, 29, 0.9);
            background: linear-gradient(to right, #b91c1c, #7f1d1d);
            color: #fee2e2;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 12px 35px rgba(127, 29, 29, 0.75);
            transition:
                opacity var(--transition-fast),
                transform var(--transition-fast),
                box-shadow var(--transition-fast),
                background var(--transition-fast);
        }

        #saveQuitBtn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 18px 45px rgba(127, 29, 29, 0.95);
            background: linear-gradient(to right, #991b1b, #7f1d1d);
        }

        #saveQuitBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Test generator card */
        #test-generator-card {
            margin-top: 18px;
            padding: 16px 14px 14px;
            border-radius: var(--radius-md);
            background: var(--card-soft);
            border: 1px solid rgba(31, 41, 55, 0.9);
        }

        #test-generator-card h3 {
            margin: 0 0 3px;
            font-size: 0.98rem;
            letter-spacing: 0.06em;
            text-transform: uppercase;
        }

        #test-generator-card p.description {
            margin: 0 0 14px;
            font-size: 0.83rem;
            color: var(--text-muted);
        }

        .field-group {
            margin-bottom: 12px;
        }

        .field-label {
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 4px;
            display: block;
            color: #e5e7eb;
        }

        .field-hint {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 6px;
        }

        .field-input {
            width: 100%;
            padding: 9px 10px;
            border-radius: 7px;
            border: 1px solid #374151;
            background: #020617;
            color: var(--text-main);
            font-size: 0.9rem;
            outline: none;
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }

        .field-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.7);
        }

        .btn-green {
            width: 100%;
            padding: 10px 14px;
            border-radius: var(--radius-md);
            border: none;
            background: linear-gradient(to right, #16a34a, #22c55e);
            color: white;
            font-size: 0.92rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 12px 30px rgba(22, 163, 74, 0.65);
            transition:
                background var(--transition-fast),
                transform var(--transition-fast),
                box-shadow var(--transition-fast);
        }

        .btn-green:hover {
            background: linear-gradient(to right, #15803d, #16a34a);
            transform: translateY(-1px);
            box-shadow: 0 18px 45px rgba(22, 163, 74, 0.95);
        }

        #generatorStatus {
            margin-top: 10px;
            font-weight: 600;
            font-size: 0.84rem;
            min-height: 1.2em;
            text-align: center;
        }

        /* Secondary (right) column card for future extensions if needed */
        .side-card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 18px 16px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-subtle);
        }

        .side-card h2 {
            margin: 0 0 10px;
            font-size: 1rem;
        }

        .side-card p {
            margin: 4px 0;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .mini-list {
            margin-top: 8px;
            padding-left: 18px;
            font-size: 0.82rem;
            color: var(--text-muted);
        }

        .mini-list li {
            margin-bottom: 4px;
        }

        @media (max-width: 900px) {
            .shell-grid {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        @media (max-width: 640px) {
            body {
                padding: 16px;
            }

            header.app-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .card {
                padding: 18px 16px;
            }
        }
    </style>
</head>
<body>

<div class="app-shell">
    <header class="app-header">
        <div class="app-title-block">
            <h1>
                <span class="icon">‚è∫</span>
                Selenium Web Action Recorder
            </h1>
            <p>Launch a browser, record interactions, and turn them into Gherkin feature files.</p>
        </div>
        <div class="badge">
            <span class="dot"></span>
            Live Recorder Panel
        </div>
    </header>

    <div class="shell-grid">
        <!-- Left: Main recorder + generator -->
        <div class="card">
            <div class="card-header">
                <div>
                    <div class="card-title">Browser Session</div>
                    <div class="card-subtitle">Start recording by launching a URL</div>
                </div>
            </div>

            <form action="/open" method="post" class="url-form">
                <input type="text" name="url" id="url-input"
                       placeholder="Enter URL (e.g., https://example.com)"
                       required>
                <button type="submit" id="launch-btn">
                    <span>üöÄ</span>
                    <span>Launch</span>
                </button>
            </form>

            <div id="control-panel">
                <div class="status-box info" id="status-message">
                    <div class="status-label">Recorder Status</div>
                    <p>Waiting for browser session...</p>
                </div>

                <button id="saveQuitBtn" onclick="saveAndQuit()" disabled>
                    üíæ Save All Actions & Quit Browser
                </button>

                <div id="test-generator-card">
                    <h3>Generate Gherkin Feature</h3>
                    <p class="description">
                        Once actions are recorded and saved, generate a Cucumber feature file from them.
                    </p>

                    <div class="field-group">
                        <label for="featureInput" class="field-label">Feature Name</label>
                        <div class="field-hint">Example: <code>User Login Flow</code></div>
                        <input
                                type="text"
                                id="featureInput"
                                class="field-input"
                                placeholder="e.g., User Login Flow"
                                required
                        >
                    </div>

                    <div class="field-group">
                        <label for="scenarioInput" class="field-label">Scenario Name</label>
                        <div class="field-hint">Example: <code>Successful Login</code></div>
                        <input
                                type="text"
                                id="scenarioInput"
                                class="field-input"
                                placeholder="e.g., Successful Login"
                                required
                        >
                    </div>

                    <button class="btn-green" onclick="generateTest()">
                        üíæ Generate Gherkin Feature
                    </button>

                    <p id="generatorStatus"></p>
                </div>
            </div>
        </div>

        <!-- Right: Info / helper panel -->
        <aside class="side-card">
            <h2>How this panel works</h2>
            <p>
                Use this control panel to coordinate between your browser, the Java backend, and the recorder script.
            </p>
            <ul class="mini-list">
                <li><strong>Launch Browser:</strong> Opens a new Selenium-driven browser session for the URL.</li>
                <li><strong>Recorder Status:</strong> Shows whether the recorder script is active and how many events
                    have been captured.
                </li>
                <li><strong>Save & Quit:</strong> Persists all recorded actions to JSON and closes the browser.</li>
                <li><strong>Generate Gherkin:</strong> Sends feature & scenario names to the Java app to generate a
                    <code>.feature</code> file.
                </li>
            </ul>
            <p style="margin-top: 10px;">
                Tip: Keep this panel open on one side of the screen and your app under test on the other for a smoother
                workflow.
            </p>
        </aside>
    </div>
</div>

<script>
    const saveQuitBtn = document.getElementById('saveQuitBtn');
    const statusBox = document.getElementById('status-message');
    let statusInterval;

    function updateStatus() {
        fetch('/recorder-status')
            .then(response => {
                if (response.status === 400) {
                    throw new Error("No active browser session detected.");
                }
                if (!response.ok) {
                    throw new Error("HTTP Error: " + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                const totalActions = data.count || 0;
                const lastStepText = data.last_raw_gherkin || '';

                statusBox.className = 'status-box info';
                statusBox.innerHTML = `
                    <div class="status-label">Recorder Status</div>
                    <p>‚úÖ Status: <strong>${data.installed ? 'ACTIVE' : 'INJECTION PENDING/FAILED'}</strong></p>
                    <p>üìä Total Recorded Actions: <strong>${totalActions}</strong></p>
                    ${
                        lastStepText
                            ? `<p>üìù Last Step: <code>${lastStepText}</code></p>`
                            : `<p>üìù Last Step: <em>No events recorded yet.</em></p>`
                    }
                `;

                saveQuitBtn.disabled = false;
                saveQuitBtn.innerText = 'üíæ Save All Actions & Quit Browser';
            })
            .catch(error => {
                statusBox.className = 'status-box error';
                statusBox.innerHTML = `
                    <div class="status-label">Recorder Status</div>
                    <p>üõë ${error.message}</p>
                    <p>Launch a URL above to begin recording.</p>
                `;
                saveQuitBtn.disabled = true;
                saveQuitBtn.innerText = 'Session Closed.';
            });
    }

    function saveAndQuit() {
        if (saveQuitBtn.disabled) return;

        saveQuitBtn.disabled = true;
        saveQuitBtn.innerText = 'Saving actions...';
        statusBox.className = 'status-box info';
        statusBox.innerHTML = `
            <div class="status-label">Recorder Status</div>
            <p>Starting save and shutdown process...</p>
        `;

        let savedFileLocation = "";

        fetch('/save-recorded-actions')
            .then(response => response.text())
            .then(message => {
                savedFileLocation = message;
                statusBox.innerHTML = `
                    <div class="status-label">Recorder Status</div>
                    <p>üíæ Actions saved. Closing browser session...</p>
                `;
                return fetch('/quit');
            })
            .then(response => response.text())
            .then(message => {
                statusBox.className = 'status-box success';
                statusBox.innerHTML = `
                    <div class="status-label">Recorder Status</div>
                    <p>‚úÖ Browser closed successfully.</p>
                    <p>üìÅ Actions saved to:<br><strong>${savedFileLocation}</strong></p>
                `;
                saveQuitBtn.innerText = 'Session Closed.';
                clearInterval(statusInterval);
            })
            .catch(error => {
                statusBox.className = 'status-box error';
                statusBox.innerHTML = `
                    <div class="status-label">Recorder Status</div>
                    <p>üõë Fatal error during shutdown:</p>
                    <p><code>${error}</code></p>
                `;
                saveQuitBtn.innerText = 'Error (Check Server Log)';
            });
    }

    window.onload = function () {
        statusInterval = setInterval(updateStatus, 2000);
        updateStatus();
    };

    function generateTest() {
        const featureName = document.getElementById('featureInput').value.trim();
        const scenarioName = document.getElementById('scenarioInput').value.trim();
        const statusDiv = document.getElementById('generatorStatus');

        if (!featureName) {
            statusDiv.textContent = "Please enter a Feature Name.";
            statusDiv.style.color = '#f97316';
            return;
        }

        if (!scenarioName) {
            statusDiv.textContent = "Please enter a Scenario Name.";
            statusDiv.style.color = '#f97316';
            return;
        }

        const payload = JSON.stringify({
            feature: featureName,
            scenario: scenarioName
        });

        statusDiv.textContent = "Generating feature file...";
        statusDiv.style.color = '#eab308';

        fetch('http://localhost:4567/generate-test', {
            method: 'POST',
            headers: {
                'Content-Type': 'text/plain', // keep as text/plain to match your existing Java endpoint
            },
            body: payload
        })
            .then(response => response.json())
            .then(data => {
                statusDiv.textContent = data.message || 'Done.';
                statusDiv.style.color = data.status === "Success" ? '#22c55e' : '#f97316';
            })
            .catch(error => {
                statusDiv.textContent = "Error communicating with Java server.";
                statusDiv.style.color = '#ef4444';
                console.error('Fetch error:', error);
            });
    }
</script>

</body>
</html>
