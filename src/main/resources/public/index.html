<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Selenium Recorder Control Panel</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        :root {
            --bg: #020617;
            --bg-alt: #020617;
            --card: #020617;
            --card-elevated: #020617;
            --border-subtle: #1f2937;
            --accent: #2563eb;
            --accent-soft: #1d4ed8;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --text-main: #e5e7eb;
            --text-muted: #9ca3af;
            --radius-lg: 16px;
            --radius-md: 10px;
            --shadow-soft: 0 20px 50px rgba(15, 23, 42, 0.85);
            --transition-fast: 0.18s ease-out;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            color: var(--text-main);
            background: radial-gradient(circle at 0% -20%, rgba(59, 130, 246, 0.45), transparent 60%),
            radial-gradient(circle at 100% -10%, rgba(236, 72, 153, 0.35), transparent 55%),
            radial-gradient(circle at 50% 110%, rgba(34, 197, 94, 0.35), transparent 60%),
            #020617;
            padding: 16px;
        }

        .app-shell {
            max-width: 1280px;
            margin: 0 auto 32px;
        }

        header.app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 20px;
        }

        .app-title-block h1 {
            margin: 0;
            font-size: 1.9rem;
            letter-spacing: 0.03em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-orb {
            width: 40px;
            height: 40px;
            border-radius: 999px;
            background: conic-gradient(
                    from 210deg,
                    #38bdf8,
                    #6366f1,
                    #ec4899,
                    #22c55e,
                    #38bdf8
            );
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.9),
            0 12px 30px rgba(15, 23, 42, 0.9);
        }

        .logo-orb-inner {
            width: 26px;
            height: 26px;
            border-radius: 999px;
            background: radial-gradient(circle at 30% 0, #e5e7eb, #020617);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
        }

        .app-title-block p {
            margin: 4px 0 0;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .badge {
            padding: 6px 12px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            font-size: 0.75rem;
            color: var(--text-muted);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(8px);
        }

        .badge-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.25);
        }

        /* Layout grid */
        .panel-grid {
            display: grid;
            grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
            gap: 16px;
        }

        .panel-row {
            display: grid;
            grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
            gap: 16px;
            margin-top: 16px;
        }

        @media (max-width: 900px) {
            .panel-grid,
            .panel-row {
                grid-template-columns: minmax(0, 1fr);
            }
        }

        /* Generic card */
        .card {
            position: relative;
            background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.4), transparent 60%),
            rgba(15, 23, 42, 0.92);
            border-radius: var(--radius-lg);
            padding: 14px 14px 12px;
            border: 1px solid rgba(31, 41, 55, 0.9);
            box-shadow: var(--shadow-soft);
            overflow: hidden;
        }

        .card::before {
            content: "";
            position: absolute;
            inset: -40%;
            background: radial-gradient(circle at 0% 0%, rgba(59, 130, 246, 0.2), transparent 55%),
            radial-gradient(circle at 100% 0%, rgba(244, 63, 94, 0.18), transparent 55%);
            mix-blend-mode: soft-light;
            opacity: 0.9;
            pointer-events: none;
        }

        .card > * {
            position: relative;
            z-index: 1;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .card-title-block {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .card-title {
            font-size: 0.95rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.09em;
        }

        .card-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .tag-pill {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            border-radius: 999px;
            padding: 3px 9px;
            border: 1px solid rgba(148, 163, 184, 0.5);
            color: #e5e7eb;
            background: rgba(15, 23, 42, 0.7);
        }

        /* URL launcher */
        .url-form {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        #url-input {
            flex-grow: 1;
            padding: 10px 11px;
            border-radius: var(--radius-md);
            border: 1px solid #374151;
            background: rgba(15, 23, 42, 0.9);
            color: var(--text-main);
            font-size: 0.9rem;
            outline: none;
            transition: border-color var(--transition-fast),
            box-shadow var(--transition-fast),
            background var(--transition-fast),
            transform var(--transition-fast);
        }

        #url-input::placeholder {
            color: #6b7280;
        }

        #url-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.7);
            transform: translateY(-0.5px);
        }

        #launch-btn {
            white-space: nowrap;
            padding: 9px 16px;
            border-radius: var(--radius-md);
            border: none;
            background: linear-gradient(to right, var(--accent), var(--accent-soft));
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 12px 26px rgba(37, 99, 235, 0.6);
            transform-origin: center;
            transition: background var(--transition-fast),
            transform var(--transition-fast),
            box-shadow var(--transition-fast);
        }

        #launch-btn span.icon {
            font-size: 1.05rem;
        }

        #launch-btn:hover {
            background: linear-gradient(to right, #1d4ed8, #1e3a8a);
            transform: translateY(-1px);
            box-shadow: 0 18px 44px rgba(37, 99, 235, 0.75);
        }

        #launch-btn:active {
            transform: translateY(0);
            box-shadow: 0 10px 20px rgba(15, 23, 42, 0.95);
        }

        /* Status + stats */
        .status-row {
            display: grid;
            grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
            gap: 10px;
            margin-bottom: 8px;
        }

        .status-box {
            padding: 10px 11px 9px;
            border-radius: var(--radius-md);
            font-size: 0.84rem;
            line-height: 1.5;
            border: 1px solid transparent;
            background: rgba(15, 23, 42, 0.9);
        }

        .status-box p {
            margin: 3px 0;
        }

        .status-label {
            font-weight: 600;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            font-size: 0.7rem;
            opacity: 0.8;
            margin-bottom: 2px;
        }

        .status-box.info {
            border-color: rgba(59, 130, 246, 0.7);
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.25);
        }

        .status-box.success {
            border-color: rgba(22, 163, 74, 0.9);
            box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.4);
        }

        .status-box.error {
            border-color: rgba(248, 113, 113, 0.9);
            box-shadow: 0 0 0 1px rgba(248, 113, 113, 0.35);
        }

        .stat-chip {
            background: rgba(15, 23, 42, 0.95);
            border-radius: 999px;
            padding: 5px 9px;
            display: inline-flex;
            align-items: center;
            gap: 7px;
            border: 1px solid rgba(55, 65, 81, 0.9);
            font-size: 0.8rem;
            margin-bottom: 4px;
        }

        .stat-chip span.label {
            color: var(--text-muted);
        }

        .stat-chip span.value {
            font-weight: 600;
            color: #e5e7eb;
        }

        code {
            background: rgba(15, 23, 42, 0.95);
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        /* Recording settings card */
        .field-group {
            margin-bottom: 8px;
        }

        .field-label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 3px;
        }

        .field-hint {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .field-input {
            width: 100%;
            padding: 8px 9px;
            border-radius: 7px;
            border: 1px solid #374151;
            background: rgba(15, 23, 42, 0.95);
            color: var(--text-main);
            font-size: 0.88rem;
            outline: none;
            transition: border-color var(--transition-fast),
            box-shadow var(--transition-fast),
            transform var(--transition-fast);
        }

        .field-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.7);
            transform: translateY(-0.5px);
        }

        /* Beautiful dark neon select */
        .select-container {
            position: relative;
            width: 180px;
        }

        .pretty-select {
            width: 100%;
            padding: 8px 12px;
            background: rgba(15, 23, 42, 0.9);
            color: #e5e7eb;
            border: 1px solid rgba(55, 65, 81, 0.9);
            border-radius: 9px;
            font-size: 0.85rem;
            appearance: none;
            outline: none;
            cursor: pointer;
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            transition: all 0.22s ease-out;
        }

        .pretty-select:hover {
            border-color: #3b82f6;
            box-shadow: 0 0 12px rgba(59, 130, 246, 0.45);
            background: rgba(30, 41, 59, 0.9);
        }

        .pretty-select:focus {
            border-color: #2563eb;
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.65);
        }

        .select-container::after {
            content: "‚ñæ";
            position: absolute;
            font-size: 0.8rem;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            pointer-events: none;
        }

        /* Buttons: save / replay / report / stop replay */
        #saveQuitBtn {
            width: 100%;
            margin-top: 4px;
            padding: 10px 14px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(127, 29, 29, 0.9);
            background: linear-gradient(to right, #b91c1c, #7f1d1d);
            color: #fee2e2;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 7px;
            box-shadow: 0 12px 28px rgba(127, 29, 29, 0.95);
            transition: opacity var(--transition-fast),
            transform var(--transition-fast),
            box-shadow var(--transition-fast),
            background var(--transition-fast);
        }

        #saveQuitBtn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 18px 40px rgba(127, 29, 29, 1);
            background: linear-gradient(to right, #991b1b, #7f1d1d);
        }

        #saveQuitBtn:disabled {
            opacity: 0.55;
            cursor: not-allowed;
            box-shadow: none;
        }

        .replay-btn {
            width: 100%;
            margin-top: 6px;
            padding: 10px 14px;
            border-radius: var(--radius-md);
            border: 1px solid #1d4ed8;
            background: linear-gradient(to right, #1d4ed8, #3b82f6);
            color: #eff6ff;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 7px;
            box-shadow: 0 12px 30px rgba(37, 99, 235, 0.75);
            transition: opacity var(--transition-fast),
            transform var(--transition-fast),
            box-shadow var(--transition-fast),
            background var(--transition-fast);
        }

        .replay-btn .replay-icon {
            font-size: 1rem;
            line-height: 1;
        }

        .replay-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 20px 50px rgba(37, 99, 235, 0.95);
            background: linear-gradient(to right, #1e40af, #2563eb);
        }

        .replay-btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.35);
        }

        .replay-btn:disabled,
        .replay-btn.is-loading {
            opacity: 0.65;
            cursor: default;
            box-shadow: none;
        }

        .replay-btn.is-loading .replay-icon {
            animation: spin 0.75s linear infinite;
        }

        .stop-btn {
            width: 100%;
            margin-top: 4px;
            padding: 9px 14px;
            border-radius: var(--radius-md);
            border: 1px solid #f97316;
            background: linear-gradient(to right, #ea580c, #f97316);
            color: #fffbeb;
            font-size: 0.88rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 7px;
            box-shadow: 0 10px 24px rgba(234, 88, 12, 0.9);
            transition: opacity var(--transition-fast),
            transform var(--transition-fast),
            box-shadow var(--transition-fast),
            background var(--transition-fast);
        }

        .stop-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 18px 40px rgba(234, 88, 12, 1);
            background: linear-gradient(to right, #c2410c, #ea580c);
        }

        .stop-btn:disabled {
            opacity: 0.5;
            cursor: default;
            box-shadow: none;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .replay-status-text {
            margin-top: 6px;
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: center;
            min-height: 1.2em;
        }

        .report-btn {
            width: 100%;
            margin-top: 6px;
            padding: 8px 12px;
            border-radius: var(--radius-md);
            border: 1px solid #0f766e;
            background: linear-gradient(to right, #0f766e, #14b8a6);
            color: #ecfeff;
            font-size: 0.88rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 7px;
            box-shadow: 0 10px 24px rgba(15, 118, 110, 0.9);
            transition: opacity var(--transition-fast),
            transform var(--transition-fast),
            box-shadow var(--transition-fast),
            background var(--transition-fast);
        }

        .report-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 18px 40px rgba(15, 118, 110, 1);
            background: linear-gradient(to right, #115e59, #0f766e);
        }

        .report-btn:disabled {
            opacity: 0.6;
            cursor: default;
            box-shadow: none;
        }

        /* Live Replay Console card */
        .live-console-card {
            background: rgba(15, 23, 42, 0.98);
            border: 1px solid rgba(55, 65, 81, 0.9);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 14px 34px rgba(0, 0, 0, 0.65);
            font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.8rem;
        }

        .console-header {
            background: #020617;
            padding: 9px 13px;
            border-bottom: 1px solid #1e293b;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .console-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .console-title {
            color: #e2e8f0;
            font-size: 0.78rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
        }

        .status-dot {
            width: 9px;
            height: 9px;
            border-radius: 999px;
            background: #475569;
            box-shadow: 0 0 0 2px rgba(71, 85, 105, 0.35);
            transition: all 0.25s;
        }

        .status-dot.live {
            background: #22c55e;
            box-shadow: 0 0 6px #22c55e;
        }

        .status-pill {
            padding: 3px 9px;
            border-radius: 999px;
            font-size: 0.7rem;
            border: 1px solid #475569;
            color: #e5e7eb;
            letter-spacing: 1px;
        }

        .status-pill.running {
            border-color: #22c55e;
            color: #bbf7d0;
        }

        .status-pill.idle {
            border-color: #475569;
            color: #94a3b8;
        }

        .console-body {
            padding: 9px 13px 12px;
            color: #e5e7eb;
        }

        .console-row {
            display: flex;
            margin-bottom: 6px;
        }

        .console-row .k {
            width: 90px;
            color: #9ca3af;
            font-size: 0.75rem;
        }

        .console-row .v {
            flex: 1;
            text-align: right;
        }

        .console-section-title {
            margin-top: 10px;
            margin-bottom: 4px;
            color: #60a5fa;
            font-weight: 600;
            font-size: 0.78rem;
        }

        .console-section-title.error-title {
            color: #f97373;
        }

        .gherkin-block {
            background: #020617;
            border: 1px solid #1f2937;
            padding: 7px 8px;
            border-radius: 8px;
            color: #facc15;
            white-space: pre-wrap;
            min-height: 42px;
            margin-bottom: 6px;
        }

        .result-text {
            display: inline-block;
            min-width: 40px;
            text-align: right;
        }

        .result-text.pass {
            color: #4ade80;
        }

        .result-text.fail {
            color: #f87171;
        }

        .error-text {
            color: #f87171;
            min-height: 16px;
            display: inline-block;
            text-align: right;
            width: 100%;
        }

        /* Gherkin generator / help card */
        .side-card {
            position: relative;
            background: radial-gradient(circle at top right, rgba(59, 130, 246, 0.22), transparent 55%),
            rgba(15, 23, 42, 0.96);
            border-radius: var(--radius-lg);
            padding: 12px 13px 11px;
            border: 1px solid rgba(31, 41, 55, 0.9);
            box-shadow: var(--shadow-soft);
            overflow: hidden;
        }

        .side-card > * {
            position: relative;
            z-index: 1;
        }

        .side-card::before {
            content: "";
            position: absolute;
            inset: -40%;
            background: radial-gradient(circle at 0% 0%, rgba(37, 99, 235, 0.25), transparent 60%),
            radial-gradient(circle at 110% 0%, rgba(249, 115, 22, 0.22), transparent 60%);
            opacity: 0.8;
            mix-blend-mode: soft-light;
            pointer-events: none;
        }

        #test-generator-card {
            margin-bottom: 10px;
            padding: 9px 10px 7px;
            border-radius: var(--radius-md);
            background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.12), transparent 55%),
            rgba(15, 23, 42, 0.98);
            border: 1px solid rgba(55, 65, 81, 0.9);
        }

        #test-generator-card h3 {
            margin: 0 0 4px;
            font-size: 0.9rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
        }

        #test-generator-card p.description {
            margin: 0 0 6px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .btn-green {
            width: 100%;
            padding: 8px 11px;
            border-radius: var(--radius-md);
            border: none;
            background: linear-gradient(to right, #16a34a, #22c55e);
            color: white;
            font-size: 0.88rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 12px 28px rgba(22, 163, 74, 0.9);
            transition: background var(--transition-fast),
            transform var(--transition-fast),
            box-shadow var(--transition-fast);
        }

        .btn-green:hover {
            background: linear-gradient(to right, #15803d, #16a34a);
            transform: translateY(-1px);
            box-shadow: 0 22px 50px rgba(22, 163, 74, 1);
        }

        #generatorStatus {
            margin-top: 5px;
            font-weight: 600;
            font-size: 0.82rem;
            min-height: 1.2em;
            text-align: center;
        }

        .side-card h2 {
            margin: 4px 0 4px;
            font-size: 0.96rem;
        }

        .side-card p {
            margin: 3px 0;
            font-size: 0.82rem;
            color: var(--text-muted);
        }

        .mini-list {
            margin-top: 6px;
            padding-left: 18px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .mini-list li {
            margin-bottom: 4px;
        }

        .pill-tip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 3px 9px;
            border-radius: 999px;
            border: 1px solid rgba(55, 65, 81, 0.9);
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .pill-tip span.icon {
            font-size: 0.85rem;
        }
    </style>
</head>
<body>

<div class="app-shell">
    <header class="app-header">
        <div class="app-title-block">
            <h1>
                <span class="logo-orb">
                    <span class="logo-orb-inner">‚è∫</span>
                </span>
                Selenium Web Action Recorder
            </h1>
            <p>Launch a browser session, record user actions, replay them, and generate Gherkin features.</p>
        </div>
        <div class="badge">
            <span class="badge-dot"></span>
            Live Recorder Panel
        </div>
    </header>

    <!-- Row 1: Session / Status (left) + Recording Settings / Actions (right) -->
    <section class="panel-grid">
        <!-- Left: Session + Status -->
        <div class="card">
            <div class="card-header">
                <div class="card-title-block">
                    <div class="card-title">Browser Session</div>
                    <div class="card-subtitle">Start recording by launching a URL under test.</div>
                </div>
                <span class="tag-pill">Selenium ¬∑ Cucumber</span>
            </div>

            <form class="url-form" onsubmit="launchBrowser(event)">
                <input
                        type="text"
                        name="url"
                        id="url-input"
                        placeholder="Enter URL (e.g., https://example.com)"
                        required
                >
                <button type="submit" id="launch-btn">
                    <span class="icon">üöÄ</span>
                    <span>Launch</span>
                </button>
            </form>

            <div class="status-row">
                <div id="status-message" class="status-box info">
                    <div class="status-label">Recorder Status</div>
                    <p>Waiting for browser session...</p>
                </div>

                <div class="status-box" style="border:1px solid rgba(55,65,81,0.9);">
                    <div class="status-label">Quick Stats</div>
                    <div class="stat-chip">
                        <span class="label">Events:</span>
                        <span class="value" id="stat-events">0</span>
                    </div>
                    <div class="stat-chip">
                        <span class="label">Script:</span>
                        <span class="value" id="stat-script">Unknown</span>
                    </div>
                </div>
            </div>

            <!-- Save & Quit button -->
            <button id="saveQuitBtn" onclick="saveAndQuit()" disabled>
                üíæ Save All Actions & Quit Browser
            </button>
        </div>

        <!-- Right: Recording name + replay + stop replay + report -->
        <div class="card">
            <div class="card-header">
                <div class="card-title-block">
                    <div class="card-title">Recording & Actions</div>
                    <div class="card-subtitle">Name your flow, replay and open reports.</div>
                </div>
            </div>

            <div class="field-group">
                <label for="recordingName" class="field-label">Recording Name</label>
                <div class="field-hint">
                    This will be used as the base name for the saved JSON file
                    (and reused when generating feature files).
                </div>
                <div style="display:flex; gap:8px; margin-bottom:4px; flex-wrap:wrap;">
                    <input
                            type="text"
                            id="recordingName"
                            class="field-input"
                            placeholder="e.g., user_login_flow"
                            style="flex:1 1 0;"
                    >
                    <div class="select-container">
                        <select id="recordingRecentNames" class="pretty-select">
                            <option value="">Recent‚Ä¶</option>
                        </select>
                    </div>
                </div>

                <label style="display:flex; align-items:center; gap:6px; font-size:0.8rem; color:#9ca3af; margin-bottom:4px;">
                    <input
                            type="checkbox"
                            id="addTimestamp"
                            checked
                            style="accent-color:#22c55e; width:14px; height:14px;"
                    >
                    <span>Append timestamp to filename (recommended)</span>
                </label>

                <div class="field-hint">
                    Final filename:
                    <code id="recordingFilenamePreview">recording_YYYYMMDD_HHMMSS.json</code>
                </div>
            </div>

            <button id="replayBtn" type="button" class="replay-btn">
                <span class="replay-icon">‚èØ</span>
                <span class="replay-label">Replay Recorded Script</span>
            </button>

            <!-- New Stop Replay button -->
            <button id="stopReplayBtn" type="button" class="stop-btn" disabled>
                ‚èπ Stop Replay & Close Driver
            </button>

            <p id="replayStatus" class="replay-status-text"></p>

            <button
                    id="openReportBtn"
                    type="button"
                    class="report-btn"
                    style="display: none;"
                    onclick="window.open('http://localhost:4567/view-replay-report', '_blank')">
                <span>üìÑ Open Last Replay Report</span>
            </button>
        </div>
    </section>

    <!-- Row 2: Live Replay Console (left) + Gherkin generator / help (right) -->
    <section class="panel-row">
        <!-- Live Replay Console -->
        <div class="live-console-card">
            <div class="console-header">
                <div class="console-left">
                    <span id="liveReplayDot" class="status-dot"></span>
                    <span class="console-title">Live Replay Console</span>
                </div>
                <span id="headerStatusPill" class="status-pill idle">IDLE</span>
            </div>
            <div class="console-body">
                <div class="console-row">
                    <div class="k">State</div>
                    <div class="v" id="liveReplayState">IDLE</div>
                </div>
                <div class="console-row">
                    <div class="k">Progress</div>
                    <div class="v" id="liveReplayProgress">0 / 0</div>
                </div>
                <div class="console-row">
                    <div class="k">Action</div>
                    <div class="v" id="liveReplayAction">-</div>
                </div>
                <div class="console-row">
                    <div class="k">Title</div>
                    <div class="v" id="liveReplayTitle">-</div>
                </div>

                <div class="console-section-title">Gherkin Step</div>
                <div id="liveReplayGherkin" class="gherkin-block">-</div>

                <div class="console-section-title">Selenium Command</div>
                <div id="liveReplaySelenium" class="gherkin-block" style="color:#e5e7eb;">-</div>

                <div class="console-row">
                    <div class="k">Result</div>
                    <div class="v">
                        <span id="liveReplayResult" class="result-text">-</span>
                    </div>
                </div>

                <div class="console-section-title error-title">Last Error</div>
                <div id="liveReplayErrorDisplay" class="error-text">-</div>
                <div id="liveReplayError" style="display:none;"></div>
            </div>
        </div>

        <!-- RIGHT: Gherkin generator + help -->
        <aside class="side-card">
            <div id="test-generator-card">
                <h3>Generate Gherkin Feature</h3>
                <p class="description">
                    After saving a recording, generate a Cucumber <code>.feature</code>
                    file using the selected recording name.
                </p>

                <div class="field-group">
                    <label for="featureInput" class="field-label">Feature Name</label>
                    <div class="field-hint">Example: <code>User Login Flow</code></div>
                    <input
                            type="text"
                            id="featureInput"
                            class="field-input"
                            placeholder="e.g., User Login Flow"
                            required
                    >
                </div>

                <div class="field-group">
                    <label for="scenarioInput" class="field-label">Scenario Name</label>
                    <div class="field-hint">Example: <code>Successful Login</code></div>
                    <input
                            type="text"
                            id="scenarioInput"
                            class="field-input"
                            placeholder="e.g., Successful Login"
                            required
                    >
                </div>

                <button type="button" class="btn-green" onclick="generateTest()">
                    üíæ Generate Gherkin Feature
                </button>

                <p id="generatorStatus"></p>
            </div>

            <h2>How this panel works</h2>
            <p>
                This panel orchestrates your Selenium session, the recorder script,
                raw JSON recordings, the replay engine and the Gherkin generator.
            </p>
            <ul class="mini-list">
                <li><strong>Launch Browser:</strong> Opens a Selenium-driven browser at your target URL.</li>
                <li><strong>Recorder Script:</strong> Injected into the page; records navigations, clicks, inputs, and
                    hovers.
                </li>
                <li><strong>Save & Quit:</strong> Persists all recorded actions into <code>/recordings/*.json</code> and
                    closes the browser.
                </li>
                <li><strong>Replay Script:</strong> Uses the JSON to drive a headless browser and produces an HTML
                    execution report.
                </li>
                <li><strong>Generate Gherkin:</strong> Turns a chosen recording into a readable Cucumber
                    <code>.feature</code> file.
                </li>
            </ul>
            <p class="pill-tip">
                <span class="icon">üí°</span>
                Tip: Keep this panel on one screen and your AUT on another for a smooth
                record ‚Üí replay ‚Üí report ‚Üí generate loop.
            </p>
        </aside>
    </section>
</div>

<script>
    const BASE_URL = 'http://localhost:4567';

    const saveQuitBtn = document.getElementById('saveQuitBtn');
    const statusBox = document.getElementById('status-message');
    const statEvents = document.getElementById('stat-events');
    const statScript = document.getElementById('stat-script');
    const replayStatus = document.getElementById('replayStatus');
    const replayBtn = document.getElementById('replayBtn');
    const stopReplayBtn = document.getElementById('stopReplayBtn');
    const openReportBtn = document.getElementById('openReportBtn');
    let statusInterval;

    // Live replay console refs
    const liveDot = document.getElementById('liveReplayDot');
    const livePill = document.getElementById('headerStatusPill');
    const liveStateEl = document.getElementById('liveReplayState');
    const liveProgEl = document.getElementById('liveReplayProgress');
    const liveActionEl = document.getElementById('liveReplayAction');
    const liveGherkinEl = document.getElementById('liveReplayGherkin');
    const liveResultEl = document.getElementById('liveReplayResult');
    const liveErrorDisp = document.getElementById('liveReplayErrorDisplay');
    const liveErrorEl = document.getElementById('liveReplayError');
    const liveTitleEl = document.getElementById('liveReplayTitle');
    const liveSelEl = document.getElementById('liveReplaySelenium');

    let replayPollTimer = null;

    const LS_KEY_LAST_NAME = '__recorder_lastRecordingName';

    function humanizeRecordingName(recName) {
        if (!recName) return '';
        const withSpaces = recName.replace(/[_\-]+/g, ' ').trim();
        return withSpaces
            .split(/\s+/)
            .map(w => w.charAt(0).toUpperCase() + w.slice(1))
            .join(' ');
    }

    function autoFillFeatureScenarioFromRecording(recName) {
        const featureInput = document.getElementById('featureInput');
        const scenarioInput = document.getElementById('scenarioInput');
        const pretty = humanizeRecordingName(recName);

        if (featureInput) {
            featureInput.value = pretty || recName || '';
        }
        if (scenarioInput) {
            scenarioInput.value = `Happy path - ${pretty || recName || ''}`;
        }
    }

    function sanitizeName(raw) {
        if (!raw) return '';
        return raw.replace(/[^a-zA-Z0-9_\-]/g, '_');
    }

    function makeTimestampForFile() {
        const now = new Date();
        const yyyy = now.getFullYear().toString();
        const mm = String(now.getMonth() + 1).padStart(2, '0');
        const dd = String(now.getDate()).padStart(2, '0');
        const hh = String(now.getHours()).padStart(2, '0');
        const mi = String(now.getMinutes()).padStart(2, '0');
        const ss = String(now.getSeconds()).padStart(2, '0');
        return `${yyyy}${mm}${dd}_${hh}${mi}${ss}`;
    }

    function buildFilename(baseName, withTimestamp) {
        const clean = sanitizeName(baseName || 'recording');
        if (withTimestamp) {
            return `${clean}_${makeTimestampForFile()}.json`;
        }
        return `${clean}.json`;
    }

    async function refreshRecordingDropdownFromServer(selectedName) {
        const select = document.getElementById('recordingRecentNames');
        if (!select) return;

        try {
            const resp = await fetch(`${BASE_URL}/recordings-list`);
            if (!resp.ok) throw new Error('HTTP ' + resp.status);

            const list = await resp.json();

            while (select.options.length > 1) {
                select.remove(1);
            }

            list.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.name;
                opt.textContent = item.name;
                if (item.fileName) {
                    opt.dataset.filename = item.fileName;
                }
                select.appendChild(opt);
            });

            if (selectedName) {
                select.value = selectedName;
            }
        } catch (e) {
            console.error('Failed to load recordings list', e);
        }
    }

    function initRecordingNameUi() {
        const nameInput = document.getElementById('recordingName');
        const tsCheckbox = document.getElementById('addTimestamp');
        const preview = document.getElementById('recordingFilenamePreview');
        const recentSelect = document.getElementById('recordingRecentNames');

        if (!nameInput) return;

        function updatePreviewForNewRecording() {
            if (!preview) return;
            const withTs = tsCheckbox ? tsCheckbox.checked : true;
            const fn = buildFilename(nameInput.value.trim(), withTs);
            preview.textContent = fn;
        }

        function onNameChanged() {
            updatePreviewForNewRecording();
            const val = nameInput.value.trim();
            if (val) {
                autoFillFeatureScenarioFromRecording(val);
            }
        }

        if (recentSelect) {
            recentSelect.addEventListener('change', () => {
                const val = recentSelect.value;

                if (!val) {
                    updatePreviewForNewRecording();
                    return;
                }

                nameInput.value = val;
                autoFillFeatureScenarioFromRecording(val);

                const selectedOpt = recentSelect.options[recentSelect.selectedIndex];
                const existingFileName = selectedOpt && selectedOpt.dataset.filename;

                if (preview) {
                    preview.textContent = existingFileName ||
                        buildFilename(nameInput.value.trim(), tsCheckbox ? tsCheckbox.checked : true);
                }
            });
        }

        nameInput.addEventListener('input', onNameChanged);

        if (tsCheckbox) {
            tsCheckbox.addEventListener('change', onNameChanged);
        }

        nameInput.addEventListener('keydown', (ev) => {
            if (ev.key === 'Enter') {
                ev.preventDefault();
                if (saveQuitBtn && !saveQuitBtn.disabled) {
                    saveQuitBtn.click();
                }
            }
        });

        onNameChanged();
    }

    function launchBrowser(event) {
        event.preventDefault();
        const urlInput = document.getElementById('url-input');
        const url = urlInput.value.trim();
        if (!url) return;

        statusBox.className = 'status-box info';
        statusBox.innerHTML = `
            <div class="status-label">Recorder Status</div>
            <p>Connecting to browser session...</p>
        `;
        statEvents.textContent = '0';
        statScript.textContent = 'Not Detected';
        saveQuitBtn.disabled = true;
        saveQuitBtn.textContent = 'Waiting for session...';

        const params = new URLSearchParams();
        params.append('url', url);

        fetch(`${BASE_URL}/open`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
            },
            body: params.toString()
        }).catch(err => {
            console.error('Error launching browser:', err);
        });
    }

    function updateStatus() {
        fetch(`${BASE_URL}/recorder-status`)
            .then(response => {
                if (response.status === 400) {
                    throw new Error("No active browser session detected.");
                }
                if (!response.ok) {
                    throw new Error("HTTP Error: " + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                const totalActions = data.count || 0;
                const lastStepText = data.last_raw_gherkin || '';

                statusBox.className = 'status-box info';
                statusBox.innerHTML = `
                    <div class="status-label">Recorder Status</div>
                    <p>‚úÖ Status: <strong>${data.installed ? 'ACTIVE' : 'INJECTION PENDING/FAILED'}</strong></p>
                    ${
                    lastStepText
                        ? `<p>üìù Last Step: <code>${lastStepText}</code></p>`
                        : `<p>üìù Last Step: <em>No events recorded yet.</em></p>`
                }
                `;

                statEvents.textContent = totalActions;
                statScript.textContent = data.installed ? 'Injected' : 'Not Detected';

                saveQuitBtn.disabled = false;
                saveQuitBtn.textContent = 'üíæ Save All Actions & Quit Browser';
            })
            .catch(error => {
                statusBox.className = 'status-box error';
                statusBox.innerHTML = `
                    <div class="status-label">Recorder Status</div>
                    <p>üõë ${error.message}</p>
                    <p>Launch a URL above to begin recording.</p>
                `;
                statEvents.textContent = '0';
                statScript.textContent = 'Not Detected';

                saveQuitBtn.disabled = true;
                saveQuitBtn.textContent = 'Session Closed.';
            });
    }

    function saveAndQuit() {
        if (saveQuitBtn.disabled) return;

        const nameInput = document.getElementById('recordingName');
        const tsCheckbox = document.getElementById('addTimestamp');

        let customName = nameInput ? nameInput.value.trim() : '';
        if (!customName) {
            alert('Please enter a Recording Name before saving.');
            if (nameInput) nameInput.focus();
            return;
        }

        const withTs = tsCheckbox ? tsCheckbox.checked : true;
        const finalFileName = buildFilename(customName, withTs);

        autoFillFeatureScenarioFromRecording(customName);
        try {
            const clean = sanitizeName(customName);
            if (clean) {
                localStorage.setItem(LS_KEY_LAST_NAME, clean);
            }
        } catch (e) {
            console.warn('[panel] Failed to save last name', e);
        }

        saveQuitBtn.disabled = true;
        saveQuitBtn.textContent = 'Saving actions...';
        statusBox.className = 'status-box info';
        statusBox.innerHTML = `
            <div class="status-label">Recorder Status</div>
            <p>Starting save and shutdown process...</p>
            <p>Target file: <code>${finalFileName}</code></p>
        `;

        let savedFileLocation = "";

        const params = new URLSearchParams();
        params.append('fileName', finalFileName);

        fetch(`${BASE_URL}/save-recorded-actions?` + params.toString())
            .then(response => response.text())
            .then(message => {
                savedFileLocation = message;
                statusBox.innerHTML = `
                    <div class="status-label">Recorder Status</div>
                    <p>üíæ Actions saved. Closing browser session...</p>
                    <p>üìÅ Saved as: <code>${finalFileName}</code></p>
                `;

                refreshRecordingDropdownFromServer(customName);

                return fetch(`${BASE_URL}/quit`);
            })
            .then(response => response.text())
            .then(message => {
                statusBox.className = 'status-box success';
                statusBox.innerHTML = `
                    <div class="status-label">Recorder Status</div>
                    <p>‚úÖ Browser closed successfully.</p>
                    <p>üìÅ Actions saved to:<br><strong>${savedFileLocation || finalFileName}</strong></p>
                `;
                saveQuitBtn.textContent = 'Session Closed.';
            })
            .catch(error => {
                statusBox.className = 'status-box error';
                statusBox.innerHTML = `
                    <div class="status-label">Recorder Status</div>
                    <p>üõë Fatal error during shutdown:</p>
                    <p><code>${error}</code></p>
                `;
                saveQuitBtn.textContent = 'Error (Check Server Log)';
            });
    }

    // Live replay console
    function updateReplayConsole(st) {
        if (!st) return;

        const running = !!st.running;

        if (liveDot && livePill) {
            if (running) {
                liveDot.classList.add('live');
                livePill.classList.remove('idle');
                livePill.classList.add('running');
                livePill.textContent = 'RUNNING';
            } else {
                liveDot.classList.remove('live');
                livePill.classList.remove('running');
                livePill.classList.add('idle');
                livePill.textContent = 'IDLE';
            }
        }

        if (liveStateEl) {
            liveStateEl.textContent = running ? 'RUNNING' : 'IDLE';
        }

        if (liveProgEl) {
            liveProgEl.textContent = `${st.currentIndex || 0} / ${st.totalSteps || 0}`;
        }

        if (liveActionEl) {
            liveActionEl.textContent = st.currentAction || '-';
        }

        if (liveTitleEl) {
            liveTitleEl.textContent = st.currentTitle || '-';
        }

        if (liveGherkinEl && st.currentGherkin) {
            liveGherkinEl.textContent = st.currentGherkin;
        }

        if (liveSelEl && st.currentSelenium) {
            liveSelEl.textContent = st.currentSelenium;
        }

        // Result logic: PASS only if lastStepSuccess, FAIL only if lastError, else '-'
        if (st.lastError) {
            const err = st.lastError;
            if (liveResultEl) {
                liveResultEl.textContent = 'FAIL';
                liveResultEl.classList.remove('pass');
                liveResultEl.classList.add('fail');
            }
            if (liveErrorDisp) liveErrorDisp.textContent = err;
            if (liveErrorEl) liveErrorEl.textContent = err;
        } else if (st.lastStepSuccess) {
            if (liveResultEl) {
                liveResultEl.textContent = 'PASS';
                liveResultEl.classList.remove('fail');
                liveResultEl.classList.add('pass');
            }
            if (liveErrorDisp) liveErrorDisp.textContent = '-';
            if (liveErrorEl) liveErrorEl.textContent = '';
        } else {
            if (liveResultEl) {
                liveResultEl.textContent = '-';
                liveResultEl.classList.remove('pass', 'fail');
            }
            if (liveErrorDisp) liveErrorDisp.textContent = '-';
        }
    }

    function startReplayPolling() {
        stopReplayPolling();
        replayPollTimer = setInterval(async () => {
            try {
                const r = await fetch(`${BASE_URL}/replay-status`);
                if (r.ok) {
                    const d = await r.json();
                    updateReplayConsole(d);
                    if (!d.running) {
                        stopReplayPolling();
                        if (stopReplayBtn) stopReplayBtn.disabled = true;
                    }
                }
            } catch (e) {
                stopReplayPolling();
                if (stopReplayBtn) stopReplayBtn.disabled = true;
            }
        }, 400);
    }

    function stopReplayPolling() {
        if (replayPollTimer) clearInterval(replayPollTimer);
        replayPollTimer = null;
    }

    if (replayBtn) {
        replayBtn.addEventListener('click', async () => {
            replayBtn.disabled = true;
            replayBtn.classList.add('is-loading');

            if (stopReplayBtn) {
                stopReplayBtn.disabled = false;
            }

            if (openReportBtn) {
                openReportBtn.style.display = "none";
            }

            if (replayStatus) {
                replayStatus.textContent = "Replaying recorded script...";
                replayStatus.style.color = "#eab308";
            }

            statusBox.className = 'status-box info';
            statusBox.innerHTML = `
                <div class="status-label">Script Replay</div>
                <p>‚è≥ Replaying recorded script...</p>
            `;

            startReplayPolling();

            try {
                const select = document.getElementById("recordingRecentNames");
                let replayUrl = `${BASE_URL}/replay`;

                if (select && select.value && select.value.trim() !== "") {
                    const recName = select.value.trim();
                    replayUrl = `${BASE_URL}/replay?recording=${encodeURIComponent(recName)}`;
                }

                const resp = await fetch(replayUrl, {method: "POST"});
                const text = await resp.text();

                if (resp.ok) {
                    statusBox.className = 'status-box success';
                    statusBox.innerHTML = `
                        <div class="status-label">Script Replay</div>
                        <p>‚úÖ Replay completed successfully.</p>
                        <p class="small">You can open the detailed HTML report using the button on the right card.</p>
                    `;
                    if (replayStatus) {
                        replayStatus.textContent = "Replay completed successfully.";
                        replayStatus.style.color = "#22c55e";
                    }
                    if (openReportBtn) {
                        openReportBtn.style.display = "inline-block";
                    }
                } else {
                    statusBox.className = 'status-box error';
                    statusBox.innerHTML = `
                        <div class="status-label">Script Replay</div>
                        <p>üõë Replay Failed:</p>
                        <p><code>${text}</code></p>
                        <p class="small">The replay report (with failures) is still available.</p>
                    `;
                    if (replayStatus) {
                        replayStatus.textContent = "Replay failed. See details above.";
                        replayStatus.style.color = "#f97316";
                    }
                    if (openReportBtn) {
                        openReportBtn.style.display = "inline-block";
                    }
                }
            } catch (err) {
                statusBox.className = 'status-box error';
                statusBox.innerHTML = `
                    <div class="status-label">Script Replay</div>
                    <p>üõë Replay failed:</p>
                    <p><code>${err.message}</code></p>
                `;
                if (replayStatus) {
                    replayStatus.textContent = "Replay failed due to an error.";
                    replayStatus.style.color = "#ef4444";
                }
                if (openReportBtn) {
                    openReportBtn.style.display = "inline-block";
                }
            } finally {
                replayBtn.disabled = false;
                replayBtn.classList.remove('is-loading');
            }
        });
    }

    // Stop Replay handler
    if (stopReplayBtn) {
        stopReplayBtn.addEventListener('click', async () => {
            stopReplayBtn.disabled = true;
            stopReplayPolling();

            try {
                // You should implement /replay-stop on Java side to:
                //  - interrupt current replay
                //  - quit the driver safely (no stacktrace thrown back)
                const resp = await fetch(`${BASE_URL}/replay-stop`, { method: 'POST' });
                const text = await resp.text();

                if (!resp.ok) {
                    throw new Error(text || 'Failed to stop replay.');
                }

                // Set console to IDLE
                if (liveDot && livePill) {
                    liveDot.classList.remove('live');
                    livePill.classList.remove('running');
                    livePill.classList.add('idle');
                    livePill.textContent = 'IDLE';
                }
                if (liveStateEl) liveStateEl.textContent = 'IDLE';

                statusBox.className = 'status-box success';
                statusBox.innerHTML = `
                    <div class="status-label">Script Replay</div>
                    <p>‚èπ Replay stopped by user. Driver closed safely.</p>
                `;

                if (replayStatus) {
                    replayStatus.textContent = "Replay stopped by user.";
                    replayStatus.style.color = "#f97316";
                }
            } catch (err) {
                statusBox.className = 'status-box error';
                statusBox.innerHTML = `
                    <div class="status-label">Script Replay</div>
                    <p>üõë Failed to stop replay:</p>
                    <p><code>${err.message}</code></p>
                `;
                if (replayStatus) {
                    replayStatus.textContent = "Failed to stop replay. Check server logs.";
                    replayStatus.style.color = "#ef4444";
                }
            }
        });
    }

    function generateTest() {
        const featureName = document.getElementById('featureInput').value.trim();
        const scenarioName = document.getElementById('scenarioInput').value.trim();
        const statusDiv = document.getElementById('generatorStatus');

        const recordingSelect = document.getElementById('recordingRecentNames');
        const recordingName = recordingSelect ? recordingSelect.value.trim() : "";

        if (!featureName) {
            statusDiv.textContent = "Please enter a Feature Name.";
            statusDiv.style.color = '#f97316';
            return;
        }

        if (!scenarioName) {
            statusDiv.textContent = "Please enter a Scenario Name.";
            statusDiv.style.color = '#f97316';
            return;
        }

        const payload = JSON.stringify({
            feature: featureName,
            scenario: scenarioName,
            recording: recordingName
        });

        statusDiv.textContent = "Generating feature file...";
        statusDiv.style.color = '#eab308';

        fetch(`${BASE_URL}/generate-test`, {
            method: 'POST',
            headers: {
                'Content-Type': 'text/plain',
            },
            body: payload
        })
            .then(response => response.json())
            .then(data => {
                statusDiv.textContent = data.message || 'Done.';
                statusDiv.style.color = data.status === "Success" ? '#22c55e' : '#f97316';
            })
            .catch(error => {
                statusDiv.textContent = "Error communicating with Java server.";
                statusDiv.style.color = '#ef4444';
                console.error('Fetch error:', error);
            });
    }

    window.onload = function () {
        statusInterval = setInterval(updateStatus, 500);
        updateStatus();

        initRecordingNameUi();
        refreshRecordingDropdownFromServer();

        if (saveQuitBtn) {
            saveQuitBtn.addEventListener('click', saveAndQuit);
        }

        window.generateTest = generateTest;
    };
</script>

</body>
</html>
